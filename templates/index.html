<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kafka Music Streaming Analysis</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-dark text-light">
    <div class="container py-4">
        <h1 class="mb-4">Kafka Music Streaming Analysis Service</h1>

        <!-- Big Data Explanation Block -->
        <div class="mb-4 p-3 bg-secondary rounded">
            <h4 class="text-white">Real-Time Streaming Summary</h4>
            <p>
                This web app shows how real-time data flows through a simplified big data pipeline built with <strong>Apache Kafka</strong>. 
                It simulates music listening activity using randomly generated events — like who’s listening, what they’re listening to, and where they’re listening from.
            </p>
            <ul>
                <li><strong>Topic:</strong> <code>music-streams</code> — the Kafka topic where all events are sent.</li>
                <li><strong>Producer:</strong> Simulates real-time users streaming songs across different genres, platforms, and locations.</li>
                <li><strong>Consumer:</strong> Picks up each message from the topic as it arrives and stores it for live analysis.</li>
                <li><strong>Flask App:</strong> Displays the data on this page and lets users filter by artist, genre, mood, rating, or platform.</li>
            </ul>
        </div>

        <!-- Filter Form -->
        <form method="get" class="mb-4 row g-3 align-items-end">
            <div class="col-md-2">
                <label for="artist" class="form-label">Artist</label>
                <input type="text" class="form-control" name="artist" id="artist" value="{{ request.args.get('artist', '') }}">
            </div>

            <div class="col-md-2">
                <label for="genre" class="form-label">Genre</label>
                <select id="genre" name="genre" class="form-select">
                    <option value="">All Genres</option>
                    {% for g in ['Classic Rock', 'Alt R&B', 'Dream Pop', 'Alt Pop', 'EDM', 'Electronica', 'Psych Rock', 'Nu Disco',
                                 'Lo-fi Pop', 'Chillwave', 'Synthpop', 'Folktronica', 'Experimental', 'City Pop', 'K-pop', 'Hip Hop',
                                 'J-Pop', 'TV Soundtrack', 'Lo-fi', 'Indie Pop', 'Indie Rock', 'Jazz Fusion', 'Pop', 'New Age', 
                                 'Jazz', 'Latin Pop', 'Funk Rock', 'Pop Rock', 'Funk'] %}
                    <option value="{{ g }}" {% if request.args.get('genre') == g %}selected{% endif %}>{{ g }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label for="platform" class="form-label">Platform</label>
                <select id="platform" name="platform" class="form-select">
                    <option value="">All Platforms</option>
                    {% for p in ['Spotify', 'Apple Music', 'YouTube Music', 'SoundCloud', 'Amazon Music'] %}
                    <option value="{{ p }}" {% if request.args.get('platform') == p %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label for="country" class="form-label">Country</label>
                <input type="text" class="form-control" name="country" id="country" value="{{ request.args.get('country', '') }}">
            </div>

            <div class="col-md-2">
                <label for="mood" class="form-label">Mood</label>
                <select id="mood" name="mood" class="form-select">
                    <option value="">All Moods</option>
                    {% for m in ['Happy', 'Sad', 'Energetic', 'Calm', 'Romantic', 'Moody', 'Chill', 'Melancholic', 'Hype', 'Dreamy', 'Dark', 'Uplifting', 'Groovy', 'Hopeful', 'Lo-fi'] %}
                    <option value="{{ m }}" {% if request.args.get('mood') == m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-1">
                <label for="rating" class="form-label">Rating</label>
                <select id="rating" name="rating" class="form-select">
                    <option value="">Any</option>
                    {% for r in range(0, 6) %}
                    <option value="{{ r }}" {% if request.args.get('rating') == r|string %}selected{% endif %}>{{ r }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-1">
                <label for="skipped" class="form-label">Skipped</label>
                <select id="skipped" name="skipped" class="form-select">
                    <option value="">Any</option>
                    <option value="yes" {% if request.args.get('skipped') == 'yes' %}selected{% endif %}>Yes</option>
                    <option value="no" {% if request.args.get('skipped') == 'no' %}selected{% endif %}>No</option>
                </select>
            </div>

            <div class="col-md-2 d-flex gap-2">
                <button type="submit" class="btn btn-warning w-100">Refresh</button>
                <a href="/" class="btn btn-secondary w-100">Clear</a>
            </div>
        </form>

        <!-- Streaming Data Table -->
        <table class="table table-dark table-striped">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Track</th>
                    <th>Artist</th>
                    <th>Genre</th>
                    <th>Platform</th>
                    <th>City</th>
                    <th>Country</th>
                    <th>Mood</th>
                    <th>Duration (s)</th>
                    <th>Listen Position</th>
                    <th>% Listened</th> <!-- New column -->
                    <th>Completed</th>
                    <th>Rating</th>
                    <th>Skipped</th>
                </tr>
            </thead>
            <tbody>
                {% for msg in messages %}
                <tr>
                    <td>{{ msg.name }}</td>
                    <td>{{ msg.title }}</td>
                    <td>{{ msg.artist }}</td>
                    <td>{{ msg.genre }}</td>
                    <td>{{ msg.platform }}</td>
                    <td>{{ msg.location.city }}</td>
                    <td>{{ msg.location.country }}</td>
                    <td>{{ msg.mood }}</td>
                    <td>{{ msg.duration_seconds }}</td>
                    <td>{{ msg.listen_position }}</td>
                    <td>{{ (msg.listen_position / msg.duration_seconds * 100) | round(1) }}%</td> <!-- New cell -->
                    <td>{{ "Yes" if msg.completed else "No" }}</td>
                    <td>{{ msg.rating }}</td>
                    <td>{{ "Yes" if msg.is_skipped else "No" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
</body>
</html>
